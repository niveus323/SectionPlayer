<html>
    <head>
        <title>Youtube 구간재생</title>
    </head>

    <body>
        <section>
            <h1>Youtube 동영상을 원하는 구간만!</h1>
            <div class="youtube">
                <div id="player"></div>
            </div>
            
        </section>
        <div class="player-options">
            <div id="update-player-button">
                <button id="player-button-redraw" type="button" class="button-playerlist"
                    onclick="redrawPlayer();">선택한 옵션으로 플레이어 업데이트</button>
                <button id="player-button-video" type="button" class="button-playerlist" onclick="addvideo();">동영상 추가</button>
            </div>
            <div id="player-functions">
                <table id="player-functions-table0" class="listbox">
                    <tbody>
                        <tr>
                            <td class="noborder player-group-header">로드할 동영상 ID</td>
                            <td class="player-group-options">
                                <div class="player-option-row">
                                    <input type="text" class="player-text-input player-tooltip-zindex" size="18" 
                                        id="playerContent0" value="mFzHr8Xyo6E" alt="동영상 ID를 입력하세요">
                                </div>
                            </td>
                            <td class="player-group-button">
                                <button id="player-button-point" type="button" class="button" onclick="play(0);">재생</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="noborder player-group-header">시작 지점</td>
                            <td class="player-group-options">
                                <div class="player-option-row">
                                    <input type="text" class="player-text-input player-tooltip-zindex" size="18"
                                    id="playerStartPoint0" value="2361" alt="2361">
                                </div>
                            </td>
                            <td class="player-group-button" rowspan="2">
                                <button id="player-button-point" type="button" class="button" onclick="setPoint(0);">설정</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="noborder player-group-header">종료 지점</td>
                                <td class="player-group-options">
                                    <div class="player-option-row">
                                        <input type="text" class="player-text-input player-tooltip-zindex" size="18"
                                        id="playerEndPoint0" value="2456" alt="2456">
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <!-- <div id="player-functions-error" class="popup">

                </div> -->

            </div>
        </div>
        <footer>

        </footer>
    </body>
    <style>
        body{
            height: auto;
            overflow:auto;
            padding: 20px;
            box-sizing: border-box;
            margin: auto;
        }
        .youtube{
            position:relative;
            /* width:100%;
            padding-bottom: 56.25%; */
            /* width:60%;
            padding-bottom: 33.75%; */
            width:80%;
            padding-bottom: 45%;
            height:0;
            margin-bottom: 5px;
        }
        #player{
            position: absolute;
            width: 100%;
            height: 100%;
        }
        /* #update-player-button{
            
        } */
        .player-options{
            border: 2px solid black;
        }
        .listbox{
            border: 3px solid blue;
        }
        .button{
            width: 100%;
            height: 100%;
        }
    </style>
    <script>
/*
TODO
1. EndPoint가 StartPoint보다 앞에있으면 오류를 알릴것
2. 사이드에 재생목록 추가하기
3. 재생할 동영상 밑에 재생구간
4. footer에 github밑 정보 띄우기
5. 화면 크기에 따라 텍스트 크기, 유튜브 화면 크기 변경(일정의 크기를 기준으로 퍼센티지 변경)
6. 유튜브 화면에 챕터구간 표시
7. 추가했지만 적용되지 않은 구간은 다른 색상으로 표시
8. 재생목록 따로 스크롤
9. 재생목록 루프 설정
10. URL에도 동영상 재생되도록
*/
        //재생시간 밑 동영상 목록을 위한 List구조
        function List(){
            this.elements ={};
            this.index=0;
            this.length=0;
        }
        List.prototype.add = function(element){
            this.length++;
            this.elements[this.index++]=element;
        }
        List.prototype.get=function(idx){
            return this.elements[idx];
        }
        List.prototype.clear=function(){
            this.elements = {};
            this.index=0;
            this.length=0;
        }
        List.prototype.set=function(idx,element){
            this.elements[idx]=element;
            if(this.length<idx){
                this.length=idx;
            }
            if(this.index<idx){
                this.index = idx;
            }
        }

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        var player;
        var videolist = new List();
        var starttimes = new List();
        var endtimes = new List();

        var videotime=0;
        var timeupdater=null;
        
        var tablenum =0;    //몇개의 재생목록을 받는 div가 생성되었는지 확인받는 변수
        var currentidx=0;
        var starttime;
        var endtime;

        function onYouTubeIframeAPIReady(){
            videolist.add("mFzHr8Xyo6E");   //기본 재생 동영상 ID
            player = new YT.Player('player',{
                host:'https://www.youtube.com',
                videoId: videolist.get(0),         
                events:{
                    'onReady': onPlayerReady
                },
                playerVars:{
                    'disablekb' : 1,
                    'controls' : 1
                }
            });
        }

        //동영상 준비되면 발생하는 함수
        function onPlayerReady(event){ 
            function updateTime(){
                var oldTime = videotime;
                //console.log(videotime);
                if(player&&player.getCurrentTime){
                    videotime=player.getCurrentTime();//동영상의 현재 재생시간을 기준으로 타이머를 설정
                }
                if(videotime!= oldTime){
                    onProgress(videotime);
                }
            }
            timeupdater = setInterval(updateTime,100);
            starttimes.add(2361);
            endtimes.add(2456);
            starttime =starttimes.get(0);
            endtime = endtimes.get(0);
            player.seekTo(starttime);
            //console.log("starttime="+starttime+", endttime="+endtime);
            event.target.playVideo();
        }

        function onProgress(currentTime){
            if(currentTime>endtime){
                if(currentidx>=tablenum) {
                    //player.pauseVideo();//모든 재생 후 일시정지
                    player.stopVideo();
                    console.log("stop");
                }
                else{          //다음 영상 재생          
                    play(++currentidx);
                    console.log("current idx = "+currentidx);
                    //player.seekTo(starttime);
                    // setPoint(currentidx);
                    // if(player.videoId!=videolist.get(currentidx)){
                    //     player.loadVideoById(videolist.get(currentidx),0);
                    // }
                }   
            }
        }

        function redrawPlayer(){//동영상 재생목록 업데이트
            updateLists();
            // videolist.clear();
            // for(i=0;i<=tablenum;i++)     videolist.add(document.getElementById("playerContent"+i).value);
            currentidx=0;
            play(0);
        }
        function  setPoint(num){
            console.log("current index is "+num);
            //currentidx=num;
            //updatePoints();
            //updateLists();
            videolist.set(num,document.getElementById("playerContent"+num).value);
            starttimes.set(num,document.getElementById("playerStartPoint"+num).value);
            endtimes.set(num,document.getElementById("playerEndPoint"+num).value);
            console.log(num+"-> "+"id="+videolist.get(num)+", start="+starttimes.get(num)+", end="+endtimes.get(num));
            // starttime = starttimes.get(num);
            // endtime = endtimes.get(num);
            //console.log("starttime="+starttime+", endttime="+endtime);
            //player.seekTo(starttime);
        }

        function addvideo(){
            var newTable = document.createElement("table");
            newTable.setAttribute("id","player-functions-table"+(++tablenum));
            console.log("재생목록 추가"+tablenum);
            newTable.setAttribute("class","listbox");
                var sectiontable="<tbody>";
                    sectiontable+="<tr>";
                        sectiontable+="<td class=\"noborder player-group-header\">로드할 동영상 ID</td>";
                        sectiontable+="<td class=\"player-group-options\">"
                            sectiontable+="<div class=\"player-option-row\">";
                                sectiontable+="<input type=\"text\" class=\"player-text-input player-tooltip-zindex\" size=\"18\" id=\"playerContent"+tablenum+"\" value=\"mFzHr8Xyo6E\" alt=\"동영상 ID를 입력하세요\">"
                            sectiontable+="</div>";
                        sectiontable+="</td>";
                        sectiontable+="<td class=\"player-group-button\">";
                                sectiontable+="<button id=\"player-button-point\" type=\"button\" class=\"button\" onclick=\"play("+tablenum +");\">재생</button>";
                            sectiontable+="</td>";
                    sectiontable+="</tr>";            
                    sectiontable+="<tr>";
                        sectiontable+="<td class=\"noborder player-group-header\">시작 지점</td>";
                        sectiontable+="<td class=\"player-group-options\">";
                            sectiontable+="<div class=\"player-option-row\">";
                                sectiontable+="<input type=\"text\" class=\"player-text-input player-tooltip-zindex\" size=\"18\" id=\"playerStartPoint"+tablenum +"\" value=\"2361\" alt=\"2361\">"
                            sectiontable+="</div>";
                        sectiontable+="</td>"
                        sectiontable+="<td class=\"player-group-button\" rowspan=\"2\">"
                            sectiontable+="<button id=\"player-button-point"+tablenum+"\" type=\"button\" class=\"button\" onclick=\"setPoint("+tablenum+");\">설정</button>"
                        sectiontable+="</td>"
                    sectiontable+="</tr>"
                    sectiontable+="<tr>"
                        sectiontable+="<td class=\"noborder player-group-header\">종료 지점</td>"
                        sectiontable+="<td class=\"player-group-options\">"
                            sectiontable+="<div class=\"player-option-row\">"
                                sectiontable+="<input type=\"text\" class=\"player-text-input player-tooltip-zindex\" size=\"18\" id=\"playerEndPoint"+tablenum +"\" value=\"2456\" alt=\"2456\">";
                            sectiontable+="</div>"
                        sectiontable+="</td>"
                    sectiontable+="</tr>"
                sectiontable+="</tbody>"
            // sectiontable+="</table>"
            newTable.innerHTML = sectiontable;
            var tableparent = document.getElementById("player-functions");
            tableparent.appendChild(newTable);
        }

        function updatePoints(){
            starttimes.clear();
            endtimes.clear();
            console.log("tablenum is "+tablenum);
            for(i=0;i<=tablenum;i++){
                var sid="playerStartPoint"+i;
                var eid="playerEndPoint"+i;
                starttimes.add(document.getElementById(sid).value);
                endtimes.add(document.getElementById(eid).value);
                console.log(i+"-> "+" start="+starttimes.get(i)+", end="+endtimes.get(i));
            }
        }
        function updateLists(){
            videolist.clear();
            starttimes.clear();
            endtimes.clear();
            for(i=0;i<=tablenum;i++){
                videolist.add(document.getElementById("playerContent"+i).value);
                starttimes.add(document.getElementById("playerStartPoint"+i).value);
                endtimes.add(document.getElementById("playerEndPoint"+i).value);
                console.log(i+"-> "+"id="+videolist.get(i)+", start="+starttimes.get(i)+", end="+endtimes.get(i));
            }
        }

        function loadvideo(){
            var url = player.getVideoUrl();
            var andpos=url.indexOf('v=');
            var id;
            if(andpos != -1){
                id = url.substring(andpos+2,url.length);
            }else{
                id = url;
            }
            if(id!=videolist.get(currentidx)){
                player.loadVideoById(
                    {'videoId':videolist.get(currentidx),'suggestedQuality':'large'});
                player.playVideoAt(starttimes.get(currentidx));
            }
        }

        function  play(idx){
            console.log("play index "+idx);
            currentidx=idx;
            setPoint(idx);
            loadvideo();
            // updateLists();
            starttime = starttimes.get(idx);
            endtime = endtimes.get(idx);
            //console.log("starttime="+starttime+", endttime="+endtime);
            player.seekTo(starttime);
            
        }
    </script> 
</html>